# Modern tmux configuration
# Set prefix key to ctrl-a
unbind C-b
set -g prefix C-a

# Modern performance and responsiveness (tmux 3.2+)
set -sg escape-time 0
set -g repeat-time 300
set -g focus-events on
set -g display-time 4000
set -g display-panes-time 4000

# Enhanced key support for modern terminals
%if "#{>=:#{version},3.2}"
    set -s extended-keys on
%endif
set -g xterm-keys on

# start first window and pane at 1, not zero
set -g base-index 1
set -g pane-base-index 1

# bind M-r to reloading the config file
bind -n M-r source-file ~/.tmux.conf \; display "Reloaded tmux config file."

# pass through a ctrl-a if you press it twice
bind C-a send-prefix

# better mnemonics for splitting panes!
bind | split-window -h
bind - split-window -v

# vim/xmonad style bindings for pane movement
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

bind-key -n M-j select-pane -t :.+1
bind-key -n M-k select-pane -t :.-1

bind-key -n M-space next-layout

# vim/xmonad style bindings for window movement
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# shift-movement keys will resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

#xmonad style window creation
bind-key -T root         M-1               if-shell "tmux list-windows | grep -q '^1:'" "run-shell 'tmux select-window -t :1'" "run-shell 'tmux new-window -t :1'"
bind-key -T root         M-2               if-shell "tmux list-windows | grep -q '^2:'" "run-shell 'tmux select-window -t :2'" "run-shell 'tmux new-window -t :2'"
bind-key -T root         M-3               if-shell "tmux list-windows | grep -q '^3:'" "run-shell 'tmux select-window -t :3'" "run-shell 'tmux new-window -t :3'"
bind-key -T root         M-4               if-shell "tmux list-windows | grep -q '^4:'" "run-shell 'tmux select-window -t :4'" "run-shell 'tmux new-window -t :4'"
bind-key -T root         M-5               if-shell "tmux list-windows | grep -q '^5:'" "run-shell 'tmux select-window -t :5'" "run-shell 'tmux new-window -t :5'"
bind-key -T root         M-6               if-shell "tmux list-windows | grep -q '^6:'" "run-shell 'tmux select-window -t :6'" "run-shell 'tmux new-window -t :6'"
bind-key -T root         M-7               if-shell "tmux list-windows | grep -q '^7:'" "run-shell 'tmux select-window -t :7'" "run-shell 'tmux new-window -t :7'"
bind-key -T root         M-8               if-shell "tmux list-windows | grep -q '^8:'" "run-shell 'tmux select-window -t :8'" "run-shell 'tmux new-window -t :8'"
bind-key -T root         M-9               if-shell "tmux list-windows | grep -q '^9:'" "run-shell 'tmux select-window -t :9'" "run-shell 'tmux new-window -t :9'"
bind-key -T root         M-enter           split-window \; select-layout
bind-key -T root         M-C               kill-pane \; select-layout

# Ghostty-optimized terminal detection
# Ghostty documentation recommends 'xterm-ghostty' as the term value
if-shell 'infocmp xterm-ghostty >/dev/null 2>&1' \
  'set -g default-terminal "xterm-ghostty"' \
  'set -g default-terminal "tmux-256color"'

# Ghostty-optimized terminal features (tmux 3.2+)
# Ghostty supports RGB, clipboard, focus events, and enhanced formatting
%if "#{>=:#{version},3.2}"
    set -g terminal-features[0] 'xterm-ghostty:RGB:clipboard:ccolour:cstyle:focus:title:sync'
    set -g terminal-features[1] 'tmux-256color:RGB:clipboard:ccolour:cstyle:focus:title'
%endif

# Fallback terminal overrides for older tmux versions
%if "#{<:#{version},3.2}"
    set -ag terminal-overrides ",xterm-ghostty:Tc,xterm-ghostty:RGB"
    set -ag terminal-overrides ",tmux-256color:Tc,tmux-256color:RGB"
    set -ag terminal-overrides ",*256col*:Tc"
%endif

# Enhanced terminal capabilities for all versions
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# fiddle with colors of status bar
set -g status-style fg=white,bg=colour0

# fiddle with colors of inactive windows
set -g window-status-style fg=white,bg=colour0,dim

# change color of active window
set -g window-status-current-style fg=white,bg=colour0,bright

# set color of regular and active panes
set -g pane-border-style fg=white,bg=default
set -g pane-active-border-style fg=white,bg=default

# set color of command line
set -g message-style fg=white,bg=colour0,bright

# Enhanced status bar configuration
set -g status-interval 5
set -g status-justify centre
set -g status-left-length 100
set -g status-right-length 100
set -g status-left "#[fg=green]#S #[fg=white]| #[fg=yellow]#I:#P"
set -g status-right "#[fg=white]#h | #[fg=cyan]%Y-%m-%d %H:%M"

# let me know when a window has new activity
set -g monitor-activity on
set -g visual-activity on

# Ghostty clipboard integration with OSC 52 support
# Ghostty has excellent clipboard support - enable all features
set -g set-clipboard on
set -g allow-passthrough on

# Platform-specific copy command (tmux 3.2+)
%if "#{>=:#{version},3.2}"
    if-shell 'test "$(uname)" = "Darwin"' \
      'set -s copy-command "pbcopy"' \
      'set -s copy-command "xclip -selection clipboard -i"'
%endif

# Enhanced copy mode settings
set -g word-separators ' @"=()[]{}:,.'
set -g copy-mode-match-style 'bg=cyan,fg=black'
set -g copy-mode-current-match-style 'bg=magenta,fg=black'

# Copy mode key bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi Escape send-keys -X cancel

# Modern copy bindings that work with copy-command
%if "#{>=:#{version},3.2}"
    bind-key -T copy-mode-vi y send-keys -X copy-selection
    bind-key -T copy-mode-vi Enter send-keys -X copy-selection
    bind-key -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-selection
    bind-key -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line \; send-keys -X copy-selection
%else
    # Fallback for older tmux versions
    if-shell 'test "$(uname)" = "Darwin"' \
      'bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"' \
      'bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"'
    if-shell 'test "$(uname)" = "Darwin"' \
      'bind-key -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe "pbcopy"' \
      'bind-key -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe "xclip -selection clipboard -i"'
%endif

#navigate the buffer with vi keybindings 
setw -g mode-keys vi

# set up alias for turning on logging
bind P pipe-pane -o "cat >>~/#W.log" \; display "Toggled logging to ~/#W.log"

# Modern session and window management
set -g renumber-windows on
set -g detach-on-destroy off

# Modern mouse support optimized for Ghostty
set -g mouse on

# Mouse drag behavior - automatically copy selections
%if "#{>=:#{version},3.2}"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel
%else
    # Fallback for older versions
    if-shell 'test "$(uname)" = "Darwin"' \
      'bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"' \
      'bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"'
%endif

bind -T root F12  \
    set prefix None \;\
    set key-table off \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
    refresh-client -S \;\

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  refresh-client -S
